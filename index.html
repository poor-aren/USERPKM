/*
 * SUNSTONE ESP32 - Lung Health Monitoring
 * 
 * Hardware:
 * - ESP32 DevKit
 * - OLED Display SSD1306 (I2C)
 * - MG811 CO2 Sensor
 * - MQ7 CO Sensor
 * - MQ3 Alcohol Sensor
 * - MQ135 Air Quality Sensor
 * - Rocker Switch
 * 
 * Libraries Required:
 * - WiFiManager
 * - PubSubClient (MQTT)
 * - Adafruit_SSD1306
 * - ArduinoJson
 */

#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <PubSubClient.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <ArduinoJson.h>

// ============================================
// CONFIGURATION (from sunstone_config.h)
// ============================================
#define AWS_IOT_ENDPOINT "a2vg3urkg4mky6-ats.iot.ap-southeast-1.amazonaws.com"
#define THING_NAME "ESP01"
#define WIFI_SSID "SUNSTONE"
#define WIFI_PASS "your_password_here"

#define TOPIC_PUBLISH "devices/ESP01/sensor"
#define TOPIC_RESULT "devices/ESP01/result"
#define TOPIC_SESSION_CLOSE "devices/ESP01/session/close"

// ============================================
// PINS
// ============================================
#define PIN_MG811 34    // CO2
#define PIN_MQ7 35      // CO
#define PIN_MQ3 32      // Alcohol
#define PIN_MQ135 33    // Air Quality
#define PIN_ROCKER 25   // Rocker Switch

// OLED Display
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// ============================================
// AWS IoT CERTIFICATES
// ============================================
// Copy content dari ESP01-certificate.pem
const char* AWS_CERT = R"EOF(
-----BEGIN CERTIFICATE-----
PASTE_YOUR_CERTIFICATE_HERE
-----END CERTIFICATE-----
)EOF";

// Copy content dari ESP01-private.key
const char* AWS_PRIVATE_KEY = R"EOF(
-----BEGIN RSA PRIVATE KEY-----
PASTE_YOUR_PRIVATE_KEY_HERE
-----END RSA PRIVATE KEY-----
)EOF";

// Amazon Root CA 1
const char* AWS_ROOT_CA = R"EOF(
-----BEGIN CERTIFICATE-----
MIIDQTCCAimgAwIBAgITBmyfz5m/jAo54vB4ikPmljZbyjANBgkqhkiG9w0BAQsF
ADA5MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6
b24gUm9vdCBDQSAxMB4XDTE1MDUyNjAwMDAwMFoXDTM4MDExNzAwMDAwMFowOTEL
MAkGA1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJv
b3QgQ0EgMTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALJ4gHHKeNXj
ca9HgFB0fW7Y14h29Jlo91ghYPl0hAEvrAIthtOgQ3pOsqTQNroBvo3bSMgHFzZM
9O6II8c+6zf1tRn4SWiw3te5djgdYZ6k/oI2peVKVuRF4fn9tBb6dNqcmzU5L/qw
IFAGbHrQgLKm+a/sRxmPUDgH3KKHOVj4utWp+UhnMJbulHheb4mjUcAwhmahRWa6
VOujw5H5SNz/0egwLX0tdHA114gk957EWW67c4cX8jJGKLhD+rcdqsq08p8kDi1L
93FcXmn/6pUCyziKrlA4b9v7LWIbxcceVOF34GfID5yHI9Y/QCB/IIDEgEw+OyQm
jgSubJrIqg0CAwEAAaNCMEAwDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMC
AYYwHQYDVR0OBBYEFIQYzIU07LwMlJQuCFmcx7IQTgoIMA0GCSqGSIb3DQEBCwUA
A4IBAQCY8jdaQZChGsV2USggNiMOruYou6r4lK5IpDB/G/wkjUu0yKGX9rbxenDI
U5PMCCjjmCXPI6T53iHTfIUJrU6adTrCC2qJeHZERxhlbI1Bjjt/msv0tadQ1wUs
N+gDS63pYaACbvXy8MWy7Vu33PqUXHeeE6V/Uq2V8viTO96LXFvKWlJbYK8U90vv
o/ufQJVtMVT8QtPHRh8jrdkPSHCa2XV4cdFyQzR1bldZwgJcJmApzyMZFo6IQ6XU
5MsI+yMRQ+hDKXJioaldXgjUkK642M4UwtBV8ob2xJNDd2ZhwLnoQdeXeGADbkpy
rqXRfboQnoZsG4q5WTP468SQvvG5
-----END CERTIFICATE-----
)EOF";

// ============================================
// GLOBALS
// ============================================
WiFiClientSecure wifiClient;
PubSubClient mqttClient(wifiClient);

unsigned long lastPublish = 0;
unsigned long publishInterval = 2000; // 2 seconds

bool sessionActive = false;
bool testRunning = false;
String latestResult = "";
float latestConfidence = 0;

// Sensor calibration offsets
int offsetMG811 = 0;
int offsetMQ7 = 0;
int offsetMQ3 = 0;
int offsetMQ135 = 0;

// ============================================
// SETUP
// ============================================
void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n=================================");
  Serial.println("SUNSTONE - Lung Health Monitor");
  Serial.println("=================================\n");

  // Initialize pins
  pinMode(PIN_ROCKER, INPUT_PULLUP);
  pinMode(PIN_MG811, INPUT);
  pinMode(PIN_MQ7, INPUT);
  pinMode(PIN_MQ3, INPUT);
  pinMode(PIN_MQ135, INPUT);

  // Initialize OLED
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println("OLED init failed!");
    while(1);
  }
  
  display.clearDisplay();
  displayBootScreen();
  
  // WiFi Setup
  Serial.println("Connecting to WiFi...");
  WiFi.mode(WIFI_STA);
  WiFi.begin(WIFI_SSID, WIFI_PASS);
  
  int wifiAttempts = 0;
  while (WiFi.status() != WL_CONNECTED && wifiAttempts < 20) {
    delay(500);
    Serial.print(".");
    wifiAttempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi connected!");
    Serial.print("IP: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nWiFi failed! Starting AP mode...");
    WiFi.softAP("SUNSTONE", "12345678");
    displayMessage("WiFi Setup Mode", "Connect to SUNSTONE");
    while(1) delay(1000);
  }

  // AWS IoT Setup
  wifiClient.setCACert(AWS_ROOT_CA);
  wifiClient.setCertificate(AWS_CERT);
  wifiClient.setPrivateKey(AWS_PRIVATE_KEY);
  
  mqttClient.setServer(AWS_IOT_ENDPOINT, 8883);
  mqttClient.setCallback(mqttCallback);
  mqttClient.setBufferSize(512);

  // Connect to MQTT
  connectToMQTT();

  // Sensor burn-in
  displayMessage("Burning Sensors", "Wait 30s...");
  Serial.println("Sensor burn-in 30s...");
  
  for(int i = 30; i > 0; i--) {
    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(0, 0);
    display.println("Burning Sensors");
    display.println();
    display.setTextSize(2);
    display.print("  ");
    display.print(i);
    display.println("s");
    display.display();
    delay(1000);
  }

  // Calibrate sensors (baseline)
  calibrateSensors();

  // Ready
  displayMessage("System Ready", "Press button");
  Serial.println("System ready. Press rocker to start.");
}

// ============================================
// LOOP
// ============================================
void loop() {
  // Maintain MQTT connection
  if (!mqttClient.connected()) {
    connectToMQTT();
  }
  mqttClient.loop();

  // Check rocker switch
  if (digitalRead(PIN_ROCKER) == LOW && !testRunning) {
    startTest();
  }

  // Publish sensor data if test running
  if (testRunning && millis() - lastPublish > publishInterval) {
    publishSensorData();
    lastPublish = millis();
  }

  // Update OLED with live sensor values
  if (!testRunning) {
    displayIdleScreen();
  }

  delay(100);
}

// ============================================
// MQTT FUNCTIONS
// ============================================
void connectToMQTT() {
  Serial.print("Connecting to AWS IoT...");
  
  int attempts = 0;
  while (!mqttClient.connected() && attempts < 3) {
    if (mqttClient.connect(THING_NAME)) {
      Serial.println(" Connected!");
      
      // Subscribe to result and session topics
      mqttClient.subscribe(TOPIC_RESULT);
      mqttClient.subscribe(TOPIC_SESSION_CLOSE);
      
      Serial.println("Subscribed to topics");
    } else {
      Serial.print(" Failed, rc=");
      Serial.println(mqttClient.state());
      delay(2000);
      attempts++;
    }
  }
}

void mqttCallback(char* topic, byte* payload, unsigned int length) {
  Serial.print("Message on topic: ");
  Serial.println(topic);
  
  // Parse JSON payload
  StaticJsonDocument<256> doc;
  deserializeJson(doc, payload, length);
  
  String topicStr = String(topic);
  
  if (topicStr == TOPIC_RESULT) {
    // Result from ML inference
    String category = doc["category"];
    float confidence = doc["confidence"];
    
    latestResult = category;
    latestConfidence = confidence;
    
    displayResult(category, confidence);
    
    Serial.print("Result: ");
    Serial.print(category);
    Serial.print(" (");
    Serial.print(confidence);
    Serial.println("%)");
    
  } else if (topicStr == TOPIC_SESSION_CLOSE) {
    // Session closed
    sessionActive = false;
    testRunning = false;
    
    displayMessage("Session Closed", "Thank You!");
    Serial.println("Session closed by backend");
    
    delay(3000);
  }
}

// ============================================
// SENSOR FUNCTIONS
// ============================================
void calibrateSensors() {
  Serial.println("Calibrating sensors...");
  
  int samples = 10;
  long sumMG811 = 0, sumMQ7 = 0, sumMQ3 = 0, sumMQ135 = 0;
  
  for(int i = 0; i < samples; i++) {
    sumMG811 += analogRead(PIN_MG811);
    sumMQ7 += analogRead(PIN_MQ7);
    sumMQ3 += analogRead(PIN_MQ3);
    sumMQ135 += analogRead(PIN_MQ135);
    delay(100);
  }
  
  offsetMG811 = sumMG811 / samples;
  offsetMQ7 = sumMQ7 / samples;
  offsetMQ3 = sumMQ3 / samples;
  offsetMQ135 = sumMQ135 / samples;
  
  Serial.println("Calibration complete");
}

void readSensors(int &mg811, int &mq7, int &mq3, int &mq135) {
  // Read raw analog values
  mg811 = analogRead(PIN_MG811);
  mq7 = analogRead(PIN_MQ7);
  mq3 = analogRead(PIN_MQ3);
  mq135 = analogRead(PIN_MQ135);
  
  // Apply calibration (optional)
  // mg811 = mg811 - offsetMG811 + 300;
  // ... etc
}

void publishSensorData() {
  int mg811, mq7, mq3, mq135;
  readSensors(mg811, mq7, mq3, mq135);
  
  // Create JSON payload
  StaticJsonDocument<256> doc;
  doc["device_id"] = THING_NAME;
  doc["timestamp"] = getISO8601Time();
  
  JsonObject sensors = doc.createNestedObject("sensors");
  sensors["raw_mg811"] = mg811;
  sensors["raw_mq7"] = mq7;
  sensors["raw_mq3"] = mq3;
  sensors["raw_mq135"] = mq135;
  
  char buffer[256];
  serializeJson(doc, buffer);
  
  // Publish to MQTT
  if (mqttClient.publish(TOPIC_PUBLISH, buffer)) {
    Serial.print("Published: ");
    Serial.println(buffer);
    
    displayTestScreen(mg811, mq7, mq3, mq135);
  } else {
    Serial.println("Publish failed!");
  }
}

String getISO8601Time() {
  // Simple timestamp (you can use NTP for accurate time)
  unsigned long ms = millis();
  char buffer[32];
  sprintf(buffer, "2025-10-06T%02d:%02d:%02dZ", 
          (int)((ms/1000)/3600) % 24,
          (int)((ms/1000)/60) % 60,
          (int)(ms/1000) % 60);
  return String(buffer);
}

// ============================================
// TEST CONTROL
// ============================================
void startTest() {
  testRunning = true;
  sessionActive = true;
  
  Serial.println("\n>>> TEST STARTED <<<\n");
  
  displayMessage("Starting Test", "Breathe...");
  delay(2000);
}

// ============================================
// DISPLAY FUNCTIONS
// ============================================
void displayBootScreen() {
  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(10, 20);
  display.println("SUNSTONE");
  display.setTextSize(1);
  display.setCursor(20, 45);
  display.println("Booting...");
  display.display();
  delay(2000);
}

void displayMessage(const char* title, const char* msg) {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  
  display.setCursor(0, 10);
  display.println(title);
  display.drawLine(0, 20, 128, 20, SSD1306_WHITE);
  
  display.setCursor(0, 30);
  display.println(msg);
  
  display.display();
}

void displayIdleScreen() {
  static unsigned long lastUpdate = 0;
  if (millis() - lastUpdate < 500) return;
  lastUpdate = millis();
  
  int mg811, mq7, mq3, mq135;
  readSensors(mg811, mq7, mq3, mq135);
  
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  
  // WiFi status
  display.setCursor(110, 0);
  if (WiFi.status() == WL_CONNECTED) {
    display.print("W");
  }
  
  // Title
  display.setCursor(0, 0);
  display.println("READY");
  display.drawLine(0, 10, 128, 10, SSD1306_WHITE);
  
  // Sensor values (compact)
  display.setCursor(0, 15);
  display.print("CO2:");
  display.print(mg811);
  display.print(" CO:");
  display.println(mq7);
  
  display.setCursor(0, 25);
  display.print("ALC:");
  display.print(mq3);
  display.print(" AIR:");
  display.println(mq135);
  
  display.setCursor(0, 50);
  display.println("Press to start");
  
  display.display();
}

void displayTestScreen(int mg811, int mq7, int mq3, int mq135) {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  
  display.setCursor(0, 0);
  display.println("TESTING...");
  display.drawLine(0, 10, 128, 10, SSD1306_WHITE);
  
  display.setCursor(0, 15);
  display.print("CO2: ");
  display.println(mg811);
  
  display.setCursor(0, 25);
  display.print("CO:  ");
  display.println(mq7);
  
  display.setCursor(0, 35);
  display.print("ALC: ");
  display.println(mq3);
  
  display.setCursor(0, 45);
  display.print("AIR: ");
  display.println(mq135);
  
  display.display();
}

void displayResult(String category, float confidence) {
  testRunning = false;
  
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  
  display.setCursor(0, 0);
  display.println("RESULT");
  display.drawLine(0, 10, 128, 10, SSD1306_WHITE);
  
  display.setTextSize(2);
  display.setCursor(10, 20);
  display.println(category);
  
  display.setTextSize(1);
  display.setCursor(10, 45);
  display.print("Conf: ");
  display.print(confidence, 1);
  display.println("%");
  
  display.display();
}
