<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunstone PPOK Detection System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .status-open { color: #10b981; }
        .status-closed { color: #6b7280; }
        .risk-rendah { background: #dcfce7; color: #166534; }
        .risk-sedang { background: #fef3c7; color: #92400e; }
        .risk-tinggi { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <header class="bg-blue-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                            <span class="text-blue-600 font-bold text-xl">S</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">Sunstone PPOK</h1>
                            <p class="text-blue-100 text-sm">Sistem Deteksi Dini PPOK</p>
                        </div>
                    </div>
                    <div id="connectionStatus" class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-gray-300 rounded-full animate-pulse"></div>
                        <span class="text-sm">Connecting...</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="bg-white shadow">
            <div class="container mx-auto px-4">
                <nav class="flex space-x-8">
                    <button onclick="switchTab('session')" class="tab-btn py-4 px-2 border-b-2 border-blue-600 text-blue-600 font-medium">
                        Sesi Baru
                    </button>
                    <button onclick="switchTab('result')" class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Hasil Pemeriksaan
                    </button>
                    <button onclick="switchTab('history')" class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Riwayat
                    </button>
                    <button onclick="switchTab('admin')" class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Monitoring Admin
                    </button>
                </nav>
            </div>
        </div>

        <div class="container mx-auto px-4 py-8">
            
            <div id="tab-session" class="tab-content active">
                <div class="max-w-2xl mx-auto">
                    <div class="bg-white rounded-lg shadow-md p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Buka Sesi Pemeriksaan Baru</h2>
                        
                        <form id="sessionForm" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Pasien</label>
                                <input type="text" id="patientName" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Masukkan nama lengkap">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nomor HP</label>
                                <input type="tel" id="patientPhone" required pattern="[0-9]{10,13}"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="08xxxxxxxxxx">
                                <p class="mt-1 text-sm text-gray-500">Format: 10-13 digit angka</p>
                            </div>
                            
                            <button type="submit" id="startSessionBtn"
                                class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition duration-200">
                                Mulai Sesi
                            </button>
                        </form>

                        <div id="activeSessionInfo" class="mt-6 hidden">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">Sesi Aktif</p>
                                        <p class="font-semibold text-gray-800" id="activePatientName"></p>
                                        <p class="text-sm text-gray-600" id="activePatientPhone"></p>
                                    </div>
                                    <button onclick="finishSession()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                        Selesai
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-result" class="tab-content">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-lg shadow-md p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Hasil Pemeriksaan Real-time</h2>
                        
                        <div id="noActiveSession" class="text-center py-12">
                            <svg class="w-24 h-24 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p class="text-gray-500">Tidak ada sesi aktif. Silakan buka sesi baru terlebih dahulu.</p>
                        </div>

                        <div id="resultContainer" class="hidden">
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-6 mb-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800">Hasil Terbaru</h3>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                        <span class="text-sm text-gray-600">Live</span>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600 mb-1">Kategori Risiko</p>
                                        <p id="latestCategory" class="text-2xl font-bold text-gray-800">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 mb-1">Confidence</p>
                                        <p id="latestConfidence" class="text-2xl font-bold text-gray-800">-</p>
                                    </div>
                                </div>
                                
                                <div class="mt-4 grid grid-cols-4 gap-2 text-sm">
                                    <div class="bg-white rounded p-2">
                                        <p class="text-gray-500 text-xs">MG811</p>
                                        <p class="font-semibold" id="sensor_mg811">-</p>
                                    </div>
                                    <div class="bg-white rounded p-2">
                                        <p class="text-gray-500 text-xs">MQ7</p>
                                        <p class="font-semibold" id="sensor_mq7">-</p>
                                    </div>
                                    <div class="bg-white rounded p-2">
                                        <p class="text-gray-500 text-xs">MQ3</p>
                                        <p class="font-semibold" id="sensor_mq3">-</p>
                                    </div>
                                    <div class="bg-white rounded p-2">
                                        <p class="text-gray-500 text-xs">MQ135</p>
                                        <p class="font-semibold" id="sensor_mq135">-</p>
                                    </div>
                                </div>
                                
                                <p class="text-xs text-gray-500 mt-3" id="latestTimestamp">Menunggu data...</p>
                            </div>

                            <button onclick="finishSession()" class="w-full bg-red-500 text-white py-3 rounded-lg hover:bg-red-600">
                                Selesai Pemeriksaan
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-history" class="tab-content">
                <div class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-lg shadow-md p-8">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Riwayat Pemeriksaan</h2>
                            <button onclick="loadHistory()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                Refresh
                            </button>
                        </div>
                        
                        <div id="historyTable" class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">No. HP</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hasil</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Confidence</th>
                                    </tr>
                                </thead>
                                <tbody id="historyBody" class="divide-y divide-gray-200">
                                    <tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-admin" class="tab-content">
                <div class="max-w-7xl mx-auto space-y-6">
                    
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Status Sistem</h3>
                        <div class="grid grid-cols-4 gap-4">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600">API Status</p>
                                <p id="adminApiStatus" class="text-xl font-bold text-blue-600">Checking...</p>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600">Lambda</p>
                                <p id="adminLambdaStatus" class="text-xl font-bold text-green-600">Active</p>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600">Total Sesi</p>
                                <p id="adminTotalSessions" class="text-xl font-bold text-purple-600">0</p>
                            </div>
                            <div class="bg-orange-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600">Sesi Aktif</p>
                                <p id="adminActiveSessions" class="text-xl font-bold text-orange-600">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Data Sensor Terbaru (20 Data)</h3>
                        <div id="adminSensorLog" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Belum ada data sensor...</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Hasil Inferensi Terbaru</h3>
                        <div id="adminInferenceLog" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Belum ada hasil inferensi...</p>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <script>
        const CONFIG = {
            API_ENDPOINT: 'https://b0gtlz3zrj.execute-api.ap-southeast-1.amazonaws.com/prod',
        };

        let currentSessionId = null;
        let resultPollingInterval = null;
        let adminPollingInterval = null;

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.remove('border-transparent', 'text-gray-500');
            event.target.classList.add('border-blue-600', 'text-blue-600');
            
            if (tabName === 'result') {
                startResultPolling();
            } else {
                stopResultPolling();
            }
            
            if (tabName === 'history') {
                loadHistory();
            }
            
            if (tabName === 'admin') {
                startAdminMonitoring();
            } else {
                stopAdminMonitoring();
            }
        }

        document.getElementById('sessionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('patientName').value;
            const phone = document.getElementById('patientPhone').value;
            const btn = document.getElementById('startSessionBtn');
            
            btn.disabled = true;
            btn.textContent = 'Membuat sesi...';
            
            try {
                const response = await fetch(`${CONFIG.API_ENDPOINT}/session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, phone })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentSessionId = data.sessionId;
                    document.getElementById('activePatientName').textContent = name;
                    document.getElementById('activePatientPhone').textContent = phone;
                    document.getElementById('activeSessionInfo').classList.remove('hidden');
                    document.getElementById('sessionForm').classList.add('hidden');
                    
                    alert('Sesi berhasil dibuka! Silakan gunakan alat ESP32.');
                } else {
                    alert('Gagal membuka sesi: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Mulai Sesi';
            }
        });

        async function finishSession() {
            if (!currentSessionId) return;
            
            if (!confirm('Yakin ingin menutup sesi ini?')) return;
            
            try {
                const encodedSessionId = encodeURIComponent(currentSessionId);
                const response = await fetch(`${CONFIG.API_ENDPOINT}/session/${encodedSessionId}/finish`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Sesi berhasil ditutup!');
                    currentSessionId = null;
                    document.getElementById('activeSessionInfo').classList.add('hidden');
                    document.getElementById('sessionForm').classList.remove('hidden');
                    document.getElementById('sessionForm').reset();
                    stopResultPolling();
                    loadHistory();
                } else {
                    alert('Gagal: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function startResultPolling() {
            if (!currentSessionId) {
                document.getElementById('noActiveSession').classList.remove('hidden');
                document.getElementById('resultContainer').classList.add('hidden');
                return;
            }
            
            document.getElementById('noActiveSession').classList.add('hidden');
            document.getElementById('resultContainer').classList.remove('hidden');
            
            pollLatestResult();
            resultPollingInterval = setInterval(pollLatestResult, 2000);
        }

        function stopResultPolling() {
            if (resultPollingInterval) {
                clearInterval(resultPollingInterval);
                resultPollingInterval = null;
            }
        }

        async function pollLatestResult() {
            if (!currentSessionId) return;
            
            try {
                const encodedSessionId = encodeURIComponent(currentSessionId);
                const response = await fetch(`${CONFIG.API_ENDPOINT}/session/${encodedSessionId}/latest`);
                const data = await response.json();
                
                if (data && data.category) {
                    document.getElementById('latestCategory').textContent = data.category;
                    document.getElementById('latestConfidence').textContent = (data.confidence * 100).toFixed(1) + '%';
                    document.getElementById('latestTimestamp').textContent = new Date(data.timestamp).toLocaleString('id-ID');
                    
                    if (data.sensor_values && data.sensor_values.length === 4) {
                        document.getElementById('sensor_mg811').textContent = data.sensor_values[0];
                        document.getElementById('sensor_mq7').textContent = data.sensor_values[1];
                        document.getElementById('sensor_mq3').textContent = data.sensor_values[2];
                        document.getElementById('sensor_mq135').textContent = data.sensor_values[3];
                    }
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }

        async function loadHistory() {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>';
            
            try {
                const response = await fetch(`${CONFIG.API_ENDPOINT}/sessions`);
                const sessions = await response.json();
                
                if (sessions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Belum ada data</td></tr>';
                    return;
                }
                
                tbody.innerHTML = sessions.map(session => `
                    <tr>
                        <td class="px-6 py-4 text-sm">${new Date(session.createdAt).toLocaleString('id-ID')}</td>
                        <td class="px-6 py-4 text-sm font-medium">${session.name}</td>
                        <td class="px-6 py-4 text-sm">${session.phone}</td>
                        <td class="px-6 py-4 text-sm">
                            <span class="status-${session.status.toLowerCase()}">${session.status}</span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            ${session.lastResultCategory ? 
                                `<span class="px-2 py-1 rounded text-xs risk-${session.lastResultCategory.toLowerCase()}">${session.lastResultCategory}</span>` : 
                                '-'}
                        </td>
                        <td class="px-6 py-4 text-sm">${session.lastResultTimestamp || '-'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading data</td></tr>';
            }
        }

        function startAdminMonitoring() {
            checkSystemStatus();
            loadHistory();
            adminPollingInterval = setInterval(checkSystemStatus, 10000);
        }

        function stopAdminMonitoring() {
            if (adminPollingInterval) {
                clearInterval(adminPollingInterval);
                adminPollingInterval = null;
            }
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch(`${CONFIG.API_ENDPOINT}/ping`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ping: true })
                });
                
                if (response.ok) {
                    document.getElementById('adminApiStatus').textContent = 'Online';
                    document.getElementById('adminApiStatus').className = 'text-xl font-bold text-green-600';
                } else {
                    document.getElementById('adminApiStatus').textContent = 'Error';
                    document.getElementById('adminApiStatus').className = 'text-xl font-bold text-red-600';
                }
                
                const sessionsResp = await fetch(`${CONFIG.API_ENDPOINT}/sessions`);
                const sessions = await sessionsResp.json();
                document.getElementById('adminTotalSessions').textContent = sessions.length;
                document.getElementById('adminActiveSessions').textContent = sessions.filter(s => s.status === 'OPEN').length;
                
            } catch (error) {
                document.getElementById('adminApiStatus').textContent = 'Offline';
                document.getElementById('adminApiStatus').className = 'text-xl font-bold text-red-600';
            }
        }

        window.addEventListener('load', () => {
            document.getElementById('connectionStatus').innerHTML = `
                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                <span class="text-sm">Connected</span>
            `;
            
            setInterval(() => {
                fetch(`${CONFIG.API_ENDPOINT}/ping`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ping: true })
                }).catch(() => {});
            }, 9 * 60 * 1000);
        });
    </script>
</body>
</html>
